# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

# Azure Developer CLI (azd) configuration
# This deploys a test environment with Azure Managed Redis and a VM for testing examples
name: redis-entra-id-test-env
metadata:
  template: redis-entra-id-test-env@0.0.1

# Note: This project uses Bicep for core infrastructure and a post-provision hook for:
# - Service Principal creation (requires Microsoft Graph API, not available in Bicep)
# - Redis access policy assignment for the Service Principal
#
# The deployment creates 3 authentication methods:
# 1. User-Assigned Managed Identity (for specific identity control)
# 2. System-Assigned Managed Identity (simplest, auto-created on VM)
# 3. Service Principal (for non-Azure environments, CI/CD)
#
# Usage:
#   azd up                              # Deploy infrastructure
#   ./run.sh setup                      # Copy examples to VM
#   ./run.sh all                        # Run all examples
#
# Environment Variables (set via azd env set):
# - REDIS_CLUSTER_POLICY: 'OSSCluster' or 'EnterpriseCluster' (default: EnterpriseCluster)
# - REDIS_SKU: Balanced_B5, MemoryOptimized_M10, etc. (default: Balanced_B5)
# - VM_ADMIN_PASSWORD: VM password (auto-generated if not set)

# Infrastructure configuration - azd will deploy this bicep template
infra:
  provider: bicep
  path: ./infra
  module: main

# Hooks for additional configuration
hooks:
  postprovision:
    shell: sh
    run: ./infra/scripts/postprovision.sh
    interactive: false
    continueOnError: false

# No application services - this is infrastructure-only for testing
# The VM will be used to run the example code manually
