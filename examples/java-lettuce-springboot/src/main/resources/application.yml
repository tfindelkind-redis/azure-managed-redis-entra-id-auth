# Azure Managed Redis - Spring Boot Configuration
# 
# CLUSTER POLICY SUPPORT:
# - EnterpriseCluster: Uses standard RedisClient (server handles slot routing)
# - OSSCluster: Uses RedisClusterClient with address remapping for SSL/SNI
#
# AUTHENTICATION METHODS (via Spring profiles):
# - user-mi: User-Assigned Managed Identity
# - system-mi: System-Assigned Managed Identity  
# - service-principal: Service Principal (Client Credentials)
#
# Run examples:
#   mvn spring-boot:run -Dspring-boot.run.profiles=user-mi
#   mvn spring-boot:run -Dspring-boot.run.profiles=system-mi
#   mvn spring-boot:run -Dspring-boot.run.profiles=service-principal

azure:
  redis:
    # Azure Managed Redis hostname (e.g., my-redis.region.redis.azure.net)
    hostname: ${REDIS_HOSTNAME:}
    # Port - typically 10000 for Azure Managed Redis
    port: ${REDIS_PORT:10000}
    # Cluster policy: "EnterpriseCluster" or "OSSCluster"
    cluster-policy: ${REDIS_CLUSTER_POLICY:EnterpriseCluster}
    # Always use SSL for Azure Managed Redis
    ssl: true

# Spring configuration
spring:
  application:
    name: lettuce-springboot-entra
  
  # Disable Spring's auto-configuration for Redis
  # We're using our custom configuration with Entra ID auth
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration
  
  main:
    allow-bean-definition-overriding: true

# Logging configuration
logging:
  level:
    root: INFO
    com.example: DEBUG
    io.lettuce.core: INFO
    redis.clients.authentication: DEBUG
    com.azure.identity: INFO
    
  pattern:
    console: "%d{HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

---
# Profile: User-Assigned Managed Identity
spring:
  config:
    activate:
      on-profile: user-mi

azure:
  auth:
    type: user-assigned-managed-identity
  identity:
    # Client ID of the User-Assigned Managed Identity
    client-id: ${AZURE_CLIENT_ID:}

---
# Profile: System-Assigned Managed Identity
spring:
  config:
    activate:
      on-profile: system-mi

azure:
  auth:
    type: system-assigned-managed-identity

---
# Profile: Service Principal
spring:
  config:
    activate:
      on-profile: service-principal

azure:
  auth:
    type: service-principal
  service-principal:
    client-id: ${AZURE_CLIENT_ID:}
    client-secret: ${AZURE_CLIENT_SECRET:}
    tenant-id: ${AZURE_TENANT_ID:}
